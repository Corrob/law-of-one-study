openapi: 3.1.0
info:
  title: Law of One Study API
  version: 1.0.0
  description: |
    AI-powered RAG chatbot API for the Ra Material (Law of One).

    The chat endpoint uses Server-Sent Events (SSE) for streaming responses.

    Live site: https://lawofone.study

servers:
  - url: https://lawofone.study
    description: Production

paths:
  /api/chat:
    post:
      summary: Send a chat message
      description: |
        Send a message to the AI assistant and receive a streaming response.

        The response uses Server-Sent Events (SSE) to stream content in real-time.
        Each event has a type and JSON data payload.
      operationId: sendChatMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            example:
              message: "What is the Law of One?"
              history: []
      responses:
        '200':
          description: SSE stream of chat events
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Server-Sent Events stream with the following event types:
                  - `session`: Session metadata with response ID (sent first, used for recovery)
                  - `meta`: Initial metadata (quotes, intent, confidence)
                  - `chunk`: Streaming content (text or quote)
                  - `suggestions`: Follow-up question suggestions
                  - `done`: Stream complete
                  - `error`: Error occurred
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                error: "Message is required"
        '429':
          description: Rate limited
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Request limit per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in window
            X-RateLimit-Reset:
              schema:
                type: string
                format: date-time
              description: When the rate limit resets
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
              example:
                error: "Too many requests. Please wait before trying again."
                retryAfter: 45
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerError'

  /api/chat/recover:
    get:
      summary: Recover a cached chat response
      description: |
        Replays cached SSE events for a given response ID. Used by the client
        to recover responses after mobile backgrounding kills the SSE connection.

        Each chat response is cached server-side for 5 minutes. If the client
        loses the SSE connection (e.g., mobile app backgrounded), it can fetch
        the full response from this endpoint using the response ID received in
        the `session` SSE event.
      operationId: recoverChatResponse
      parameters:
        - name: id
          in: query
          required: true
          schema:
            type: string
            format: uuid
          description: Response ID from the `session` SSE event
      responses:
        '200':
          description: Cached response events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecoveryResponse'
        '400':
          description: Invalid or missing id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          description: Response not found (expired or invalid ID)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: Rate limited
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'

  /api/search:
    post:
      summary: Search the Ra Material
      description: |
        Semantic search across all 106 sessions of the Ra Material.

        Supports two search modes:
        - `sentence`: Search individual sentences for precise quote matching
        - `passage`: Search full question/answer pairs for concept exploration
      operationId: searchRaMaterial
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            examples:
              sentenceSearch:
                summary: Search by sentence
                value:
                  query: "no protection from storms"
                  mode: "sentence"
                  limit: 20
              passageSearch:
                summary: Search by passage
                value:
                  query: "What is the harvest?"
                  mode: "passage"
                  limit: 10
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                error: "Search query must be at least 2 characters"
        '429':
          description: Rate limited
          headers:
            X-RateLimit-Limit:
              schema:
                type: integer
              description: Request limit per window
            X-RateLimit-Remaining:
              schema:
                type: integer
              description: Remaining requests in window
            X-RateLimit-Reset:
              schema:
                type: string
                format: date-time
              description: When the rate limit resets
            Retry-After:
              schema:
                type: integer
              description: Seconds until retry is allowed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServerError'

components:
  schemas:
    ChatRequest:
      type: object
      required:
        - message
        - history
      properties:
        message:
          type: string
          description: The user's message
          maxLength: 5000
          example: "What is the Law of One?"
        history:
          type: array
          description: Previous messages in the conversation
          maxItems: 20
          items:
            $ref: '#/components/schemas/ChatMessage'

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant]
          description: Who sent the message
        content:
          type: string
          description: Message content
          maxLength: 10000
        quotesUsed:
          type: array
          description: Quote references used in the message (for deduplication)
          items:
            type: string
          example: ["50.7", "51.1"]

    SSESessionEvent:
      type: object
      description: Session metadata sent as the first event in the stream
      properties:
        responseId:
          type: string
          format: uuid
          description: Unique ID for this response (used for recovery via /api/chat/recover)

    SSEMetaEvent:
      type: object
      description: Initial metadata sent at start of response
      properties:
        quotes:
          type: array
          items:
            $ref: '#/components/schemas/Quote'
        intent:
          $ref: '#/components/schemas/QueryIntent'
        confidence:
          $ref: '#/components/schemas/IntentConfidence'
        concepts:
          type: array
          items:
            type: string
          description: Detected Law of One concepts

    SSEChunkEvent:
      oneOf:
        - $ref: '#/components/schemas/TextChunk'
        - $ref: '#/components/schemas/QuoteChunk'

    TextChunk:
      type: object
      properties:
        type:
          type: string
          enum: [text]
        content:
          type: string
          description: Text content to display

    QuoteChunk:
      type: object
      properties:
        type:
          type: string
          enum: [quote]
        text:
          type: string
          description: Quote text content
        reference:
          type: string
          description: Quote reference (e.g., "50.7")
        url:
          type: string
          format: uri
          description: URL to the quote on lawofone.info

    SSESuggestionsEvent:
      type: object
      properties:
        items:
          type: array
          items:
            type: string
          maxItems: 3
          description: Follow-up question suggestions

    SSEErrorEvent:
      type: object
      properties:
        code:
          $ref: '#/components/schemas/ChatErrorCode'
        message:
          type: string
          description: User-friendly error message
        retryable:
          type: boolean
          description: Whether the request can be retried

    Quote:
      type: object
      properties:
        text:
          type: string
          description: Full quote text
        reference:
          type: string
          description: Session.question reference
          example: "50.7"
        url:
          type: string
          format: uri
          description: Link to lawofone.info

    QueryIntent:
      type: string
      enum:
        - quote-search
        - conceptual
        - practical
        - personal
        - comparative
        - meta
        - off-topic
      description: Detected intent of the user's query

    IntentConfidence:
      type: string
      enum: [high, medium, low]
      description: Confidence in intent classification

    ChatErrorCode:
      type: string
      enum:
        - AUGMENTATION_FAILED
        - EMBEDDING_FAILED
        - SEARCH_FAILED
        - STREAM_FAILED
        - QUOTE_PROCESSING_FAILED
        - SUGGESTIONS_FAILED
        - RATE_LIMITED
        - VALIDATION_ERROR
        - UNKNOWN_ERROR

    RecoveryResponse:
      type: object
      description: Cached SSE events for response recovery
      properties:
        events:
          type: array
          items:
            $ref: '#/components/schemas/CachedEvent'
        complete:
          type: boolean
          description: Whether the response finished generating (contains a done event)

    CachedEvent:
      type: object
      description: A cached SSE event for replay
      properties:
        event:
          type: string
          description: SSE event type (meta, chunk, suggestions, done, error)
        data:
          type: object
          description: Event payload (same schema as the corresponding SSE event)

    ValidationError:
      type: object
      properties:
        error:
          type: string

    RateLimitError:
      type: object
      properties:
        error:
          type: string
        retryAfter:
          type: integer
          description: Seconds until retry is allowed

    ServerError:
      type: object
      properties:
        error:
          type: string
          example: "Failed to process request"

    SearchRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: The search query
          minLength: 2
          maxLength: 500
          example: "What is the harvest?"
        mode:
          type: string
          enum: [sentence, passage]
          default: passage
          description: |
            Search mode:
            - `sentence`: Search individual sentences for precise quote matching
            - `passage`: Search full question/answer pairs for concept exploration
        limit:
          type: integer
          minimum: 1
          maximum: 50
          default: 20
          description: Maximum number of results to return

    SearchResponse:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/SearchResult'
        query:
          type: string
          description: The original search query
        totalResults:
          type: integer
          description: Number of results returned
        mode:
          type: string
          enum: [sentence, passage]
          description: The search mode used

    SearchResult:
      type: object
      description: |
        Search result with mode-specific fields.
        Sentence mode returns `sentence`, `sentenceIndex`, `speaker`.
        Passage mode returns `text`.
      properties:
        text:
          type: string
          description: Full passage text (passage mode only)
        sentence:
          type: string
          description: Matched sentence text (sentence mode only)
        sentenceIndex:
          type: integer
          description: Index of sentence within passage (sentence mode only)
        speaker:
          type: string
          enum: [Ra, Questioner, both]
          description: Who spoke the sentence (sentence mode only)
        reference:
          type: string
          description: Session.question reference
          example: "50.7"
        session:
          type: integer
          description: Session number (1-106)
        question:
          type: integer
          description: Question number within session
        url:
          type: string
          format: uri
          description: Link to lawofone.info
        score:
          type: number
          description: Relevance score (higher is better)
