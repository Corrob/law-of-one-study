# Suggestion Generation System

This document describes how follow-up suggestion chips are generated and tuned.

## Overview

After each AI response, 3 follow-up suggestions are displayed as clickable chips. These are generated by a secondary LLM call using `SUGGESTION_GENERATION_PROMPT`.

## Key Files

| File | Purpose |
|------|---------|
| `src/lib/prompts.ts` | Contains `SUGGESTION_GENERATION_PROMPT` (lines ~506-620) |
| `src/app/api/chat/route.ts` | `generateSuggestions()` and `getFallbackSuggestions()` functions |
| `src/components/SuggestionChips.tsx` | Frontend rendering of suggestion buttons |

## Intent Categories

Suggestions are tailored based on detected query intent:

| Intent | Description | Suggestion Style |
|--------|-------------|------------------|
| `quote-search` | User wants specific Ra passages | More quotes, session references |
| `conceptual` | User wants to understand a concept | Deeper explanations, related concepts |
| `practical` | User wants how-to guidance | Practices, exercises, routines (appropriate here) |
| `personal` | User sharing emotional/vulnerable content | Gentle, supportive, with escape hatches |
| `comparative` | User comparing to other traditions | Academic comparisons, parallels |
| `meta` | Questions about the tool itself | Tool usage, topic exploration |

## Key Rules in the Prompt

1. **RESPOND TO INVITATIONS** - If AI asks a question, first suggestion should answer it
2. **STAY SPECIFIC** - Use exact terms from the conversation
3. **MATCH EMOTIONAL CONTEXT** - Personal queries get gentle suggestions + escape hatches
4. **BREADTH AFTER DEPTH** - After 5+ turns, offer option to explore new topics
5. **ADAPT TO RESPONSE LENGTH** - Different strategies for short vs long responses
6. **MATCH INTENT CATEGORY** - Suggestions must match the user's apparent intent

## Avoiding Aggressive Practice Suggestions

A key design decision: **practice/meditation/journaling suggestions should only appear for `practical` intent queries**.

### Bad Patterns (explicitly banned)

- Time-commitment suggestions for non-practical queries: "7-day plan", "10-minute routine", "daily practice"
- Prescriptive practice for conceptual/quote queries: "Try meditating on this", "Journal about..."
- Assuming application when user just wants information

### Examples

| Query Type | Bad Suggestion | Good Suggestion |
|------------|---------------|-----------------|
| Quote search | "How do I apply this?" | "Show me the full passage" |
| Conceptual | "Start a daily practice" | "How does this relate to X?" |
| Comparative | "Integrate both into your practice" | "What are the key differences?" |
| Personal | "Start a 7-day plan" | "I'd like to explore something else" |

## Fallback Suggestions

If the LLM returns fewer than 3 suggestions, `getFallbackSuggestions()` provides defaults based on intent. These are defined in `route.ts` and should be non-prescriptive for non-practical intents.

## Testing

Use `run-test-queries.ts` to test suggestion quality:

```bash
# Start dev server first
npm run dev

# Run tests (takes ~4 min due to rate limiting)
npx tsx run-test-queries.ts

# Results saved to test-results.json
```

The script runs 30 queries across all intent categories and captures suggestions for analysis.

## Current Rating & Future Improvements

**Current UI/UX Rating: 7.5/10**

### Potential improvements:

1. **Personal category**: Could shift further from "try this practice" toward "what does Ra say about..." (more info-seeking)
2. **Length enforcement**: Some suggestions exceed the 50-char guideline
3. **Variety detection**: Avoid all 3 suggestions being the same "type"
4. **Response-echo detection**: Avoid suggesting what the AI just mentioned

## History

- **2026-01-02**: Added RULE 6 (MATCH INTENT CATEGORY) to restrict practice suggestions to practical intent only. Updated fallback suggestions to be less prescriptive.
